<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Polyglot Live ‚Äî Speaker</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500&family=IBM+Plex+Sans:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080c14;
    --surface: #0d1220;
    --surface2: #131929;
    --border: rgba(255,255,255,0.07);
    --accent: #00d4ff;
    --accent2: #7b61ff;
    --text: #e8edf7;
    --muted: #5a6478;
    --live: #00ff88;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'IBM Plex Sans', sans-serif;
    min-height: 100vh;
  }
  body::before {
    content:'';position:fixed;inset:0;
    background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.03) 2px,rgba(0,0,0,0.03) 4px);
    pointer-events:none;z-index:1000;
  }
  body::after {
    content:'';position:fixed;inset:0;
    background-image:linear-gradient(rgba(0,212,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,0.03) 1px,transparent 1px);
    background-size:40px 40px;pointer-events:none;
  }
  header {
    padding:18px 32px;display:flex;align-items:center;justify-content:space-between;
    border-bottom:1px solid var(--border);position:relative;z-index:10;
  }
  .logo { display:flex;align-items:center;gap:10px; }
  .logo-icon {
    width:32px;height:32px;border:1.5px solid var(--accent);border-radius:6px;
    display:flex;align-items:center;justify-content:center;font-size:14px;color:var(--accent);
  }
  .logo h1 { font-family:'IBM Plex Mono',monospace;font-size:14px;font-weight:500;letter-spacing:0.12em;text-transform:uppercase; }
  .logo span { color:var(--muted);font-weight:300; }
  .role-badge {
    padding:5px 14px;border-radius:4px;font-family:'IBM Plex Mono',monospace;font-size:11px;
    letter-spacing:0.1em;text-transform:uppercase;border:1px solid rgba(0,212,255,0.3);
    color:var(--accent);background:rgba(0,212,255,0.07);
  }

  .main { position:relative;z-index:10;padding:28px 32px;display:flex;flex-direction:column;gap:24px; }

  /* Room code card */
  .room-card {
    background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:22px 28px;
    display:flex;align-items:center;gap:24px;flex-wrap:wrap;
  }
  .room-info { flex:1; }
  .room-label { font-family:'IBM Plex Mono',monospace;font-size:11px;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);margin-bottom:8px; }
  .room-code {
    font-family:'IBM Plex Mono',monospace;font-size:32px;font-weight:500;letter-spacing:0.15em;
    color:var(--accent);text-shadow:0 0 20px rgba(0,212,255,0.3);
  }
  .room-hint { font-size:13px;color:var(--muted);margin-top:6px; }
  .room-hint a { color:var(--accent2);text-decoration:none; }
  .room-actions { display:flex;flex-direction:column;gap:10px; }
  .copy-btn {
    padding:9px 20px;border-radius:7px;border:1px solid var(--border);background:var(--surface2);
    color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:12px;letter-spacing:0.06em;
    cursor:pointer;transition:all 0.2s;
  }
  .copy-btn:hover { border-color:rgba(0,212,255,0.3);color:var(--accent); }
  .copy-btn.copied { border-color:rgba(0,255,136,0.3);color:var(--live); }

  /* Controls */
  .controls {
    background:var(--surface);border:1px solid var(--border);border-radius:12px;
    padding:18px 24px;display:flex;align-items:center;gap:16px;flex-wrap:wrap;
  }
  label { font-size:11px;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);font-family:'IBM Plex Mono',monospace; }
  select {
    background:var(--surface2);border:1px solid var(--border);color:var(--text);
    padding:7px 12px;border-radius:6px;font-family:'IBM Plex Sans',sans-serif;font-size:13px;cursor:pointer;outline:none;
  }
  select:focus { border-color:var(--accent); }
  .mic-btn {
    margin-left:auto;display:flex;align-items:center;gap:10px;padding:10px 28px;border-radius:8px;
    border:1.5px solid var(--accent);background:rgba(0,212,255,0.05);color:var(--accent);
    font-family:'IBM Plex Mono',monospace;font-size:13px;letter-spacing:0.08em;cursor:pointer;transition:all 0.2s;
  }
  .mic-btn:hover { background:rgba(0,212,255,0.12);box-shadow:0 0 20px rgba(0,212,255,0.15); }
  .mic-btn.recording { background:rgba(0,255,136,0.08);border-color:var(--live);color:var(--live);box-shadow:0 0 20px rgba(0,255,136,0.15); }

  /* Status bar */
  .status-row { display:flex;align-items:center;gap:16px;font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--muted); }
  .dot { width:7px;height:7px;border-radius:50%;background:var(--muted);transition:all 0.3s; }
  .dot.live { background:var(--live);box-shadow:0 0 8px var(--live);animation:pulse 1.5s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.4} }

  /* Transcript */
  .transcript-card {
    background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;flex:1;
  }
  .card-header {
    padding:12px 20px;border-bottom:1px solid var(--border);font-family:'IBM Plex Mono',monospace;
    font-size:11px;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);display:flex;align-items:center;gap:10px;
  }
  .waveform { display:flex;align-items:center;gap:2px;height:16px; }
  .wave-bar { width:3px;border-radius:2px;background:var(--live);animation:wave 0.8s ease-in-out infinite;transform-origin:bottom; }
  .wave-bar:nth-child(1){animation-delay:0s;height:6px}
  .wave-bar:nth-child(2){animation-delay:0.1s;height:12px}
  .wave-bar:nth-child(3){animation-delay:0.2s;height:16px}
  .wave-bar:nth-child(4){animation-delay:0.1s;height:10px}
  .wave-bar:nth-child(5){animation-delay:0s;height:5px}
  @keyframes wave { 0%,100%{transform:scaleY(0.4);opacity:0.5}50%{transform:scaleY(1);opacity:1} }

  .transcript-body { padding:22px 24px;font-size:16px;line-height:1.75;min-height:140px; }
  .interim { color:var(--muted);font-style:italic; }
  .placeholder { color:var(--muted);font-size:14px;text-align:center;padding:30px 0; }

  /* Relay status */
  .relay-status { display:flex;align-items:center;gap:6px;font-size:12px;font-family:'IBM Plex Mono',monospace; }
  .relay-dot { width:6px;height:6px;border-radius:50%;background:var(--muted); }
  .relay-dot.ok { background:var(--live); }
  .relay-dot.err { background:#ff5555; }

  .error-msg {
    background:rgba(255,60,60,0.08);border:1px solid rgba(255,60,60,0.2);border-radius:8px;
    padding:12px 18px;font-size:13px;color:#ff7777;
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">‚¨°</div>
    <h1>POLYGLOT <span>// LIVE</span></h1>
  </div>
  <div class="role-badge">üéô Speaker</div>
</header>

<div class="main">

  <!-- Room Code -->
  <div class="room-card">
    <div class="room-info">
      <div class="room-label">Room Code ‚Äî Share with audience</div>
      <div class="room-code" id="roomCode">--------</div>
      <div class="room-hint">Audience opens <strong>audience.html</strong> and enters this code</div>
    </div>
    <div class="room-actions">
      <button class="copy-btn" onclick="copyCode()">üìã Copy Code</button>
      <button class="copy-btn" onclick="copyLink()">üîó Copy Audience Link</button>
    </div>
    <div>
      <img id="qrImg" src="" alt="QR Code" style="width:100px;height:100px;border-radius:8px;display:none">
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <label>Speaking in</label>
    <select id="sourceLang">
      <option value="en">English</option>
      <option value="es">Spanish</option>
      <option value="fr">French</option>
      <option value="de">German</option>
      <option value="zh-CN">Mandarin</option>
      <option value="ja">Japanese</option>
      <option value="pt">Portuguese</option>
      <option value="ru">Russian</option>
      <option value="ar">Arabic</option>
      <option value="vi">Vietnamese</option>
    </select>
    <div style="margin-left:auto;display:flex;align-items:center;gap:16px">
      <div class="status-row">
        <div class="dot" id="liveDot"></div>
        <span id="statusText">STANDBY</span>
        <div class="relay-dot" id="relayDot"></div>
        <span id="relayText">RELAY ‚Äî</span>
      </div>
      <button class="mic-btn" id="micBtn" onclick="toggleRecording()">‚è∫ START</button>
    </div>
  </div>

  <!-- Transcript -->
  <div class="transcript-card">
    <div class="card-header">
      <span>Live Transcript</span>
      <div id="waveformWrap" style="display:none">
        <div class="waveform">
          <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
          <div class="wave-bar"></div><div class="wave-bar"></div>
        </div>
      </div>
    </div>
    <div class="transcript-body" id="transcriptBody">
      <div class="placeholder">üéô Press START and begin speaking. Audience will receive your words in real time.</div>
    </div>
  </div>

</div>

<script>
// ‚îÄ‚îÄ Room Code ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function genCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 8; i++) code += chars[Math.floor(Math.random() * chars.length)];
  return code;
}

let roomCode = localStorage.getItem('polyglot-room') || genCode();
localStorage.setItem('polyglot-room', roomCode);
document.getElementById('roomCode').textContent = roomCode;

// QR code for audience.html?room=CODE
const audienceURL = window.location.href.replace('speaker.html', 'audience.html') + '?room=' + roomCode;
const qrSrc = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(audienceURL)}&size=100x100&bgcolor=0d1220&color=00d4ff&margin=8`;
const qrImg = document.getElementById('qrImg');
qrImg.src = qrSrc;
qrImg.style.display = 'block';

function copyCode() {
  navigator.clipboard.writeText(roomCode);
  const btn = event.target;
  btn.textContent = '‚úì Copied!';
  btn.classList.add('copied');
  setTimeout(() => { btn.textContent = 'üìã Copy Code'; btn.classList.remove('copied'); }, 2000);
}
function copyLink() {
  navigator.clipboard.writeText(audienceURL);
  const btn = event.target;
  btn.textContent = '‚úì Copied!';
  btn.classList.add('copied');
  setTimeout(() => { btn.textContent = 'üîó Copy Audience Link'; btn.classList.remove('copied'); }, 2000);
}

// ‚îÄ‚îÄ Speech Recognition ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let recognition = null;
let isRecording = false;
let finalTranscript = '';
let publishDebounce = null;
let lastPublished = '';

function toggleRecording() {
  isRecording ? stopRecording() : startRecording();
}

function startRecording() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { alert('Speech recognition requires Chrome or Edge.'); return; }

  recognition = new SR();
  recognition.lang = document.getElementById('sourceLang').value;
  recognition.continuous = true;
  recognition.interimResults = true;

  recognition.onstart = () => {
    isRecording = true;
    document.getElementById('micBtn').className = 'mic-btn recording';
    document.getElementById('micBtn').innerHTML = '‚èπ STOP';
    document.getElementById('liveDot').classList.add('live');
    document.getElementById('statusText').textContent = 'LIVE';
    document.getElementById('waveformWrap').style.display = 'block';
  };

  recognition.onresult = (e) => {
    let interim = '';
    finalTranscript = '';
    for (let i = 0; i < e.results.length; i++) {
      if (e.results[i].isFinal) finalTranscript += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    updateTranscript(finalTranscript, interim);

    if (finalTranscript && finalTranscript !== lastPublished) {
      clearTimeout(publishDebounce);
      publishDebounce = setTimeout(() => {
        publishTranscript(finalTranscript);
        lastPublished = finalTranscript;
      }, 500);
    }
  };

  recognition.onerror = (e) => { if (e.error !== 'no-speech') console.error(e.error); };
  recognition.onend = () => { if (isRecording) try { recognition.start(); } catch(e) {} };
  recognition.start();
}

function stopRecording() {
  isRecording = false;
  if (recognition) recognition.stop();
  document.getElementById('micBtn').className = 'mic-btn';
  document.getElementById('micBtn').innerHTML = '‚è∫ START';
  document.getElementById('liveDot').classList.remove('live');
  document.getElementById('statusText').textContent = 'STANDBY';
  document.getElementById('waveformWrap').style.display = 'none';
}

function updateTranscript(final, interim) {
  const body = document.getElementById('transcriptBody');
  let html = final ? `<span>${esc(final)}</span>` : '';
  if (interim) html += `<span class="interim"> ${esc(interim)}</span>`;
  body.innerHTML = html || '<div class="placeholder">üéô Speak now...</div>';
  body.scrollTop = body.scrollHeight;
}

function esc(t) {
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ‚îÄ‚îÄ Relay via ntfy.sh ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TOPIC = 'polyglot-' + roomCode.toLowerCase();

async function publishTranscript(text) {
  const srcLang = document.getElementById('sourceLang').value;
  const payload = JSON.stringify({ text, sourceLang: srcLang, ts: Date.now() });

  try {
    const res = await fetch(`https://ntfy.sh/${TOPIC}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Title': 'transcript' },
      body: payload
    });
    const ok = res.ok;
    document.getElementById('relayDot').className = 'relay-dot ' + (ok ? 'ok' : 'err');
    document.getElementById('relayText').textContent = ok ? 'RELAY ‚úì' : 'RELAY ‚úó';
  } catch(e) {
    document.getElementById('relayDot').className = 'relay-dot err';
    document.getElementById('relayText').textContent = 'RELAY ‚úó';
  }
}
</script>
</body>
</html>
